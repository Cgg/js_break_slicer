<html>
<head>
<meta charset='utf-8'>
<title>JS Break Slicer</title>
</head>

<body>

<select id='sample_combo'>
  <option value='amen.ogg'>Amen break</option>
  <option value='think.ogg'>Think break</option>
  <option value='apache.ogg'>Apache break</option>
</select>

<button id="play">Play</button>

<canvas id="visu">not supported.</canvas>

<script>
var audioCtx = new AudioContext();

window.onload = function()
{
var editor = {};

document.getElementById('sample_combo').addEventListener('change',
  function(e) {
    loadSample(e.target.value);
});

document.getElementById("play").addEventListener("click", function(e) {
  toggle_current_playing();
});

function rms(buf, offset, len) {
  var rms = 0;
  if (buf.length < offset + len) {
    len = buf.length - offset;
  }
  if (len == 0) {
    return 0;
  }
  for (var i = 0; i < len; i++) {
    var v = buf[offset + i];
    rms += Math.sqrt(v * v);
  }
  rms /= len;
  return rms;
}

function toggle_current_playing() {
  if (editor.playing) {
    stop_playback();
  }
  else {
    start_playback();
  }
}

function start_playback() {
  if (!editor.buffer) {
    return;
  }
  stop_playback();

  var source = audioCtx.createBufferSource();
  source.buffer = editor.buffer;
  source.loop = true;
  source.connect(audioCtx.destination);
  editor.source = source;

  source.start();

  document.getElementById("play").innerHTML = "Pause";
  editor.playing = true;
}

function stop_playback() {
  if (editor.source) {
    editor.source.stop(0);
    editor.source = null;
  }
  document.getElementById("play").innerHTML = "Play";
  editor.playing = false;
}

function draw_editor(data) {
  if (!editor.buffer) {
    return;
  }
  cvs = document.getElementById('visu')
  var factor = data.length / window.innerWidth;
  cvs.width = data.length / factor;
  cvs.height = 256;
  var c = cvs.getContext("2d");
  var b = data.getChannelData(0);
  c.fillStyle = "#000";

  var j = 0;
  var max = 0;
  // rms by chunk to determine a normalization factor
  for (var i = 0; i < b.length; i=Math.floor(i+factor)) {
    var rmsvalue = rms(b, i, factor);
    max = Math.max(max, rmsvalue);
  }
  var boost = (0.5 / max) * 256;
  for (var i = 0; i < b.length; i=Math.floor(i+factor)) {
    var rmsvalue = rms(b, i, factor) * boost;
    rmsvalue = Math.max(1.0, rmsvalue);
    c.fillStyle = "rgba(0, 0, 0, 1.0)";
    c.fillRect(j++, cvs.height / 1.3, 1.5, -rmsvalue * 1.5);
    c.fillStyle = "rgba(0, 0, 0, 0.4)";
    c.fillRect(j++, cvs.height / 1.3, 1.5, +rmsvalue * 0.5);
  }
}

function loadSample(uneURL) {
  var xhr = new XMLHttpRequest;
  xhr.open("GET", uneURL, true);
  xhr.responseType = 'arraybuffer';
  xhr.onload = function(e) {
    audioCtx.decodeAudioData(xhr.response, function(data){
      editor.buffer = data;
      draw_editor(data);
      if (editor.playing) {
        start_playback();
      }
    });
  }
  xhr.onerror = function(e) {
    console.log(e);
  }
  xhr.send(null);
}

loadSample(document.getElementById('sample_combo').value);

}
</script>

</body>

</html>

